# APPI Knowledge Base Development Container
FROM mcr.microsoft.com/devcontainers/typescript-node:1-20-bookworm

# システム依存関係のインストール
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends \
        # PDF処理用ライブラリ
        poppler-utils \
        # 日本語フォント・ロケール
        fonts-noto-cjk \
        locales \
        # ネットワークツール
        curl \
        wget \
        # テキスト処理
        jq \
        # 監視・デバッグ
        htop \
        tree \
    && apt-get autoremove -y && apt-get clean -y

# 日本語ロケール設定
RUN sed -i '/ja_JP.UTF-8/s/^# //g' /etc/locale.gen && locale-gen
ENV LANG=ja_JP.UTF-8
ENV LANGUAGE=ja_JP:ja
ENV LC_ALL=ja_JP.UTF-8

# Node.js グローバルツールのインストール
RUN npm install -g \
    tsx \
    typescript \
    @typescript-eslint/cli \
    prettier

# 作業ディレクトリ設定
WORKDIR /workspace

# package.json をコピーして依存関係を事前インストール（キャッシュ最適化）
COPY package*.json ./
RUN npm ci

# ユーザー権限調整
RUN chown -R vscode:vscode /workspace

# 開発用エイリアス・環境設定
RUN echo 'alias ll="ls -la"' >> /home/vscode/.zshrc \
    && echo 'alias ingest="npm run ingest"' >> /home/vscode/.zshrc \
    && echo 'alias build="npm run build"' >> /home/vscode/.zshrc \
    && echo 'export PATH="$PATH:/workspace/node_modules/.bin"' >> /home/vscode/.zshrc

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node --version || exit 1

USER vscode
