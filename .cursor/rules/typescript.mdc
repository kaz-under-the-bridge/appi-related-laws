---
description: TypeScript/Node.jsé–‹ç™ºãƒ«ãƒ¼ãƒ«ï¼ˆAPPIé–¢é€£æ³•ä»¤KBï¼‰
globs: ["src/**/*.ts", "*.ts", "*.js"]
alwaysApply: true
---

# TypeScript/Node.js é–‹ç™ºãƒ«ãƒ¼ãƒ«

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### åŸºæœ¬æ–¹é‡
- **ES Modules**ã‚’ä½¿ç”¨ï¼ˆimport/exportï¼‰
- **Strict TypeScript**è¨­å®šã‚’ç¶­æŒ
- **é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°**ã‚’å„ªå…ˆï¼ˆå‰¯ä½œç”¨ã‚’æœ€å°é™ã«ï¼‰
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**ã¯å¿…é ˆï¼ˆtry-catch + é©åˆ‡ãªãƒ­ã‚°ï¼‰

### å‘½åè¦å‰‡
- **ãƒ•ã‚¡ã‚¤ãƒ«å**: kebab-case (`url-parser.ts`, `ingest-utils.ts`)
- **é–¢æ•°å**: camelCase (`generateSlug`, `parseUrlList`)
- **å‹å**: PascalCase (`UrlListEntry`, `IngestedDocument`)
- **å®šæ•°**: UPPER_SNAKE_CASE (`PROJECT_ROOT`, `MAX_RETRIES`)

### ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åº
```typescript
// 1. Node.jsæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import * as fs from 'fs/promises';
import * as path from 'path';

// 2. ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£
import axios from 'axios';
import { z } from 'zod';

// 3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
import { generateSlug } from './utils.js';
import type { UrlListEntry } from './types.js';
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
// âŒ æ‚ªã„ä¾‹
function riskyFunction() {
  return JSON.parse(data); // ã‚¨ãƒ©ãƒ¼å‡¦ç†ãªã—
}

// âœ… è‰¯ã„ä¾‹  
function safeFunction(data: string): ParseResult {
  try {
    return { success: true, data: JSON.parse(data) };
  } catch (error) {
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'Parse error' 
    };
  }
}
```

## Zodã‚¹ã‚­ãƒ¼ãƒæ´»ç”¨

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆç®‡æ‰€
- å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ï¼ˆURLä¸€è¦§ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çµæœï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å‰ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿

### ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ä¾‹
```typescript
// å‹å®‰å…¨æ€§ã‚’ä¿ã¤ãŸã‚Zodã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹ã‚’ç”Ÿæˆ
export const ConfigSchema = z.object({
  maxRetries: z.number().min(1).max(10).default(3),
  timeout: z.number().min(1000).default(30000),
  userAgent: z.string().default('APPI-KB-Bot/1.0')
});

export type Config = z.infer<typeof ConfigSchema>;
```

## éåŒæœŸå‡¦ç†

### Promise/async-await
- **callbackåœ°ç„ã‚’å›é¿** - Promise chainã‹async/awaitã‚’ä½¿ç”¨
- **ä¸¦åˆ—å‡¦ç†**ãŒå¯èƒ½ãªå ´åˆã¯`Promise.all`ã‚’æ´»ç”¨
- **é€æ¬¡å‡¦ç†**ãŒå¿…è¦ãªå ´åˆã®ã¿for-awaitã‚’ä½¿ç”¨

```typescript
// âœ… ä¸¦åˆ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
const results = await Promise.all(
  urls.map(url => downloadContent(url))
);

// âœ… é€æ¬¡å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
for (const url of urls) {
  await processUrl(url);
  await sleep(1000); // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
}
```

### ã‚¨ãƒ©ãƒ¼å¢ƒç•Œ
```typescript
// å€‹åˆ¥ã‚¨ãƒ©ãƒ¼ã‚’å…¨ä½“å‡¦ç†ã«å½±éŸ¿ã•ã›ãªã„
const results = await Promise.allSettled(
  entries.map(async (entry) => {
    try {
      return await processEntry(entry);
    } catch (error) {
      console.error(`Failed to process ${entry.title}:`, error);
      return { error: error.message, entry };
    }
  })
);
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ

### ãƒ‘ã‚¹æ“ä½œ
- `path.join()`ã‚’å¿…ãšä½¿ç”¨ï¼ˆOSéä¾å­˜ï¼‰
- çµ¶å¯¾ãƒ‘ã‚¹ã§ã®æ“ä½œã‚’å„ªå…ˆ
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯ + ä½œæˆã‚’è‡ªå‹•åŒ–

```typescript
// âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
const filePath = path.join(PROJECT_ROOT, 'sources', `${slug}.pdf`);
await ensureDir(path.dirname(filePath));
await fs.writeFile(filePath, buffer);
```

### ãƒ•ã‚¡ã‚¤ãƒ«å‘½å
- **ã‚¹ãƒ©ãƒƒã‚°åŒ–**: æ—¥æœ¬èªâ†’è‹±æ•°å­—ãƒã‚¤ãƒ•ãƒ³å¤‰æ›
- **é‡è¤‡å›é¿**: ãƒãƒƒã‚·ãƒ¥ä»˜ä¸ã§ä¸€æ„æ€§æ‹…ä¿
- **æ‹¡å¼µå­**: Content-Typeã«åŸºã¥ãé©åˆ‡ãªæ‹¡å¼µå­

## ãƒ­ã‚°ãƒ»ãƒ‡ãƒãƒƒã‚°

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
- **é€²æ—è¡¨ç¤º**: `[1/10]` å½¢å¼ã§ç¾åœ¨ä½ç½®ã‚’æ˜ç¤º
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: çµµæ–‡å­—ã§è¦–è¦šçš„ã«åŒºåˆ¥ï¼ˆâœ…âŒâš ï¸ğŸ“¥ğŸ’¾ï¼‰
- **ã‚¨ãƒ©ãƒ¼è©³ç´°**: ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯é–‹ç™ºæ™‚ã®ã¿ã€æœ¬ç•ªã¯è¦ç´„

```typescript
console.log(`\n[${i + 1}/${total}] å‡¦ç†ä¸­: ${entry.title}`);
console.log(`ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${url}`);
console.log(`âœ… å®Œäº†: ${slug} (${textLength}æ–‡å­—)`);
```

### æ§‹é€ åŒ–ãƒ­ã‚°ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
```typescript
// JSONå½¢å¼ã§ãƒ­ã‚°å‡ºåŠ›ï¼ˆç›£è¦–ãƒ»åˆ†æç”¨ï¼‰
const logEntry = {
  timestamp: new Date().toISOString(),
  level: 'info',
  operation: 'ingest',
  slug,
  url: normalizedUrl,
  success: true,
  textLength,
  warnings: extractionResult.warnings
};
```

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆå¯¾è±¡
- `utils.ts` ã®ç´”ç²‹é–¢æ•°ï¼ˆ`generateSlug`, `normalizeUrl`ï¼‰
- `parsers.ts` ã®Markdownè§£æ
- Zodã‚¹ã‚­ãƒ¼ãƒã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒ¢ãƒƒã‚¯å¯¾è±¡
- HTTPé€šä¿¡ï¼ˆaxiosï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ“ä½œï¼ˆfsï¼‰
- å¤–éƒ¨ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆpdf-parseï¼‰

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒ¡ãƒ¢ãƒªç®¡ç†
- å¤§ããªPDFãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã‚’æ¤œè¨
- Bufferä½¿ç”¨æ™‚ã¯é©åˆ‡ãªè§£æ”¾
- ä¸è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã‚’é¿ã‘ã‚‹

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: 30ç§’
- **ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹**: 3å›ã¾ã§ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 1ç§’é–“éš”ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

## è¨­å®šç®¡ç†

### ç’°å¢ƒå¤‰æ•°
```typescript
const config = {
  timeout: parseInt(process.env.TIMEOUT || '30000'),
  maxRetries: parseInt(process.env.MAX_RETRIES || '3'),
  userAgent: process.env.USER_AGENT || 'APPI-KB-Bot/1.0'
};
```

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- é–‹ç™º: `config/development.json`
- æœ¬ç•ª: `config/production.json`
- Zodã‚¹ã‚­ãƒ¼ãƒã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### URLæ¤œè¨¼
- HTTPSã‚’å„ªå…ˆã€HTTPã¯è­¦å‘Šè¡¨ç¤º
- chrome-extensionç­‰ã®ä¸æ­£URLã‚’æ‹’å¦
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆå®˜å…¬åºã‚µã‚¤ãƒˆã®ã¿ï¼‰

### ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
- Content-Typeã¨ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ100MBä»¥ä¸‹ï¼‰
- ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå°†æ¥çš„ã«ï¼‰

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨

### ãƒ“ãƒ«ãƒ‰
```bash
npm run build  # TypeScript â†’ JavaScript
npm run lint   # ESLintå®Ÿè¡Œ
npm run test   # Jestå®Ÿè¡Œ
```

### å®Ÿè¡Œ
```bash
npm run ingest              # å…¨ä»¶å–å¾—
npm run ingest -- --url=... # å˜ä¸€URLå‡¦ç†
npm run dev                 # é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆwatchï¼‰
```
